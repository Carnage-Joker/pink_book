{% extends 'base.html' %}
{% load static custom_filters %}
{% block content %}

<h1 class="text-center">âœ¨ Dress Up Your Avatar âœ¨</h1>

<!-- ðŸ‘— Avatar Display Container -->
<div id="avatar-preview" class="avatar-frame" style="position: relative; width: 200px; height: 400px; margin: 0 auto;">
    {% for layer in layer_keys %}
        <img 
            src="{{ image_urls|get_item:layer }}" 
            alt="{{ layer }}" 
            class="avatar-layer {{ layer }}"
            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; z-index: {{ forloop.counter }};"
        >
    {% endfor %}
</div>

<!-- ðŸ’… Item Palette with drag support -->
<div id="item-palette" class="grid grid-cols-4 gap-4 mt-6 text-center">
  {% for item in available_items %}
    <img 
      src="{% static item.image_path %}" 
      alt="{{ item.name }}" 
      class="item cursor-pointer border rounded"
      style="max-width: 60px;" 
      draggable="true" 
      data-id="{{ item.id }}"
    >
  {% endfor %}
</div>

<!-- ðŸ” Clothing selection using arrows -->
<div id="clothing-selection" class="mt-10 space-y-4 text-center">
  {% for part in "top,skirt,shoes,accessory"|split:"," %}
  <div class="clothing-item" id="{{ part }}-selection">
      <button type="button" onclick="changeItem('{{ part }}','prev')">âŸ¨</button>
      <img id="{{ part }}-preview" src="{% static 'dressup/avatars/'|add:part|add:'/00.png' %}" alt="{{ part }}" style="max-height: 60px;">
      <button type="button" onclick="changeItem('{{ part }}','next')">âŸ©</button>
  </div>
  {% endfor %}
</div>

<!-- ðŸ’¾ Outfit Save Form -->
<form method="POST" class="mt-6 text-center">
    {% csrf_token %}
    {% for part in "top,skirt,shoes,accessory"|split:"," %}
        <input type="hidden" name="{{ part }}" id="{{ part }}-input" value="">
    {% endfor %}
    <button type="submit" id="save-outfit" class="px-4 py-2 bg-pink-500 text-white rounded hover:bg-pink-600 mt-4">
        Save Outfit ðŸ’–
    </button>
</form>

{% endblock %}

{% block scripts %}
<script>
// Available clothing codes (expand as needed)
const OPTIONS = {
  top: ['00', '01', '02'],
  skirt: ['00', '01', '02'],
  shoes: ['00', '01', '02'],
  accessory: ['00', '01', '02'],
};

function changeItem(category, direction) {
  const input = document.getElementById(`${category}-input`);
  const current = input.value || '00';
  const options = OPTIONS[category];
  let idx = options.indexOf(current);
  if (idx < 0) idx = 0;
  idx = (direction === 'next') ? (idx + 1) % options.length : (idx - 1 + options.length) % options.length;
  const newCode = options[idx];
  input.value = newCode;
  document.getElementById(`${category}-preview`).src = `/static/dressup/avatars/${category}/${newCode}.png`;
}

document.addEventListener('DOMContentLoaded', () => {
  for (let part of ['top', 'skirt', 'shoes', 'accessory']) {
    document.getElementById(`${part}-input`).value = '00';
  }

  // Drag-and-drop logic
  document.querySelectorAll('.item').forEach(item => {
    item.addEventListener('dragstart', e => {
      e.dataTransfer.setData('item-id', item.dataset.id);
    });
  });

  document.querySelectorAll('.avatar-layer').forEach(layer => {
    layer.addEventListener('dragover', e => e.preventDefault());
    layer.addEventListener('drop', e => {
      e.preventDefault();
      const itemId = e.dataTransfer.getData('item-id');
      fetch(`/dressup/equip_item_ajax/${itemId}/`)
        .then(res => res.json())
        .then(data => {
          if (data.status === 'equipped') {
            const img = document.querySelector(`.avatar-layer.${data.category}`);
            if (img) img.src = data.image_url;
          }
        });
    });
  });
});
</script>
{% endblock %}
