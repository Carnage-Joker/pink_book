{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block content %}

<style>
/*** ---  LAYOUT  --------------------------------------------------------- ***/
.inventory-wrapper {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1.5rem;
  margin-top: 1.5rem;
}

.avatar‑and‑controls {
  display: flex;
  gap: 2rem;
  width: 100%;
  max-width: 1100px;
}

/*** ---  AVATAR SECTION  ------------------------------------------------- ***/
.avatar-stage {
  position: relative;
  width: 280px;
  height: 500px;
  flex-shrink: 0;
  background: url("{% static 'dressup/img/closet_bg.jpg' %}") center/cover no-repeat;
  border: 4px solid hotpink;
  border-radius: 12px;
  overflow: hidden;
}

.avatar-stage img.layer {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  object-fit: contain;
  pointer-events: none;
}

/*** ---  CONTROL PANEL  -------------------------------------------------- ***/
.control-panel {
  flex: 1;
  background:#ffe6f3;
  border:3px dashed hotpink;
  border-radius:12px;
  padding:1rem;
  overflow-y:auto;
  max-height:520px;
}
.control-panel h3{
  margin-top:0;
  color:deeppink;
  text-align:center;
}
.category-block{
  margin-bottom:1rem;
}
.category-block h4{
  margin:0 0 .4rem;
  color:hotpink;
  font-weight:600;
  display:flex;
  align-items:center;
  gap:.4rem;
}
.category-block button.arrow{
  background:#ff90c1;
  border:none;
  color:#fff;
  font-weight:bold;
  width:26px;
  height:26px;
  border-radius:50%;
  cursor:pointer;
}
.thumbnail‑bar{
  display:flex;
  flex-wrap:wrap;
  gap:.3rem;
}
.thumbnail‑bar img{
  width:40px;
  height:40px;
  object-fit:contain;
  border:2px solid transparent;
  border-radius:6px;
  cursor:pointer;
  transition:transform .2s,border-color .2s;
}
.thumbnail‑bar img:hover{
  transform:scale(1.05);
  border-color:#ff90c1;
}
.thumbnail‑bar img.equipped{
  border-color:hotpink;
}

/*** ---  BUTTON BAR  ----------------------------------------------------- ***/
.button‑bar{
  display:flex;
  justify-content:center;
  gap:1rem;
}
.button‑bar button,
.button‑bar a{
  background:hotpink;
  color:#fff!important;
  border:none;
  padding:.6rem 1.3rem;
  font-weight:600;
  border-radius:8px;
  text-decoration:none;
  transition:transform .15s;
}
.button‑bar button:hover,
.button‑bar a:hover{
  transform:scale(1.05);
}

/*** ---  SCROLLBAR prettier (optional) ----------------------------------- ***/
.control-panel::-webkit-scrollbar{width:8px;}
.control-panel::-webkit-scrollbar-thumb{background:#ff90c1;border-radius:4px;}
</style>

<div class="inventory-wrapper">
  <h1 style="color:deeppink;"><strong>♡  Closet Make‑Over  ♡</strong></h1>

  <div class="avatar‑and‑controls">

    <!-- -------------  AVATAR  ------------- -->
    <div class="avatar-stage">
      {% for layer in layer_keys %}
        <img id="layer-{{ layer }}" class="layer {{ layer }}"
             src="{{ image_urls|get_item:layer }}"
             alt="{{ layer|capfirst }}">
      {% endfor %}
    </div>

    <!-- -------------  CONTROL PANEL ------------- -->
    <div class="control-panel">

      <h3>Style Picker</h3>

            {# === loop over categories we allow cycling === #}
        {% for cat in categories %}
        <div class="category-block" id="block-{{ cat }}">
            <h4>
            <button class="arrow prev-arrow" data-category="{{ cat }}">←</button>
            {{ cat|capfirst }}
            <button class="arrow next-arrow" data-category="{{ cat }}">→</button>
            </h4>

            <div class="thumbnail‑bar">
            {% for p in purchased_items %}
                {% if p.item.category == cat %}
                <img src="{% static p.item.image_path %}"
                    data-item-id="{{ p.item.id }}"
                    data-category="{{ cat }}"
                    title="{{ p.item.name }}"
                    alt="{{p.item.name}}"
                    class="{% if p.item in equipped_items %}equipped{% endif %}">
                {% endif %}
            {% endfor %}
            </div>
        </div>
          {# All purchased items of this category as tiny thumbs #}
          </div>
        </div>
      {% endfor %}
    </div><!-- control‑panel -->
  </div><!-- avatar‑and‑controls -->


  <!-- ----------  MAIN FORM  ---------- -->
  <form method="POST">
    {% csrf_token %}
    <input type="hidden" id="hair-input"      name="hair"      value="{{ avatar.hair }}">
    <input type="hidden" id="top-input"       name="top"       value="{{ avatar.top }}">
    <input type="hidden" id="skirt-input"     name="skirt"     value="{{ avatar.skirt }}">
    <input type="hidden" id="shoes-input"     name="shoes"     value="{{ avatar.shoes }}">
    <input type="hidden" id="accessory-input" name="accessory" value="{{ avatar.accessory }}">
    <div class="button‑bar">
      <button type="submit" name="save_outfit">Save outfit</button>
      <button type="submit" name="fav_outfit">❤ Favourite</button>
      <a href="{% url 'dressup:mall' %}">Back to Mall</a>
      <a href="{% url 'journal:dashboard' %}">Dashboard</a>
    </div>
  </form>
</div><!-- inventory‑wrapper -->

{% endblock %}



{% block scripts %}
{{ block.super }}
<script>
/* ------------------------------------------------------------------
   simple in‑memory index store for next/prev cycling
------------------------------------------------------------------ */
const categoryMap = {
  hair:      ['00.png','01.png','02.png','03.png'],
  top:       ['00.png','01.png','02.png','03.png','04.png'],
  skirt:     ['00.png','01.png','02.png','03.png','04.png'],
  shoes:     ['00.png','01.png','02.png'],
  accessory: ['00.png','01.png','02.png','03.png']
};
const currentIndex = {hair:0,top:0,skirt:0,shoes:0,accessory:0};

/* -------- helper to refresh one layer + hidden input ------------- */
function refreshLayer(category, code){      // code is e.g. '01'
  // update image layer
  const img   = document.getElementById(`layer-${category === 'accessory' ? 'accessories':category}`);
  if(img){
    img.src = `/static/dressup/avatars/${category}/${code}.png`;
  }
  // update hidden form field
  const input = document.getElementById(`${category}-input`);
  if(input){
    input.value = code;
  }
}

/* -------- arrow buttons (cycle through sprites) ------------------ */
document.querySelectorAll('.prev-arrow').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const cat = btn.dataset.category;
    const total = categoryMap[cat].length;
    currentIndex[cat] = (currentIndex[cat] - 1 + total) % total;
    const code = categoryMap[cat][currentIndex[cat]].replace('.png','');
    refreshLayer(cat, code);
  });
});
document.querySelectorAll('.next-arrow').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const cat = btn.dataset.category;
    const total = categoryMap[cat].length;
    currentIndex[cat] = (currentIndex[cat] + 1) % total;
    const code = categoryMap[cat][currentIndex[cat]].replace('.png','');
    refreshLayer(cat, code);
  });
});

/* -------- thumbnail clicks (equip/unequip via POST) -------------- */
document.querySelectorAll('.thumbnail‑bar img').forEach(thumb=>{
  thumb.addEventListener('click', ()=>{
    // highlight UI
    thumb.parentElement.querySelectorAll('img').forEach(x=>x.classList.remove('equipped'));
    thumb.classList.add('equipped');
    // live preview
    const cat  = thumb.dataset.category;
    const path = thumb.getAttribute('src');
    const code = path.split('/').pop().replace('.png','');
    refreshLayer(cat, code);
    // write code to hidden field – server will treat it as direct selection;
    // if you prefer the equip_item POST, you can instead fire fetch(...) here.
  });
});
</script>
{% endblock %}
